#!/usr/bin/env node
import{Command as je}from"@commander-js/extra-typings";import{platform as F,homedir as _}from"node:os";import{join as b}from"node:path";import{lstatSync as k,readdirSync as J,existsSync as v}from"node:fs";import{outputJson as L,readJson as H,pathExists as M}from"fs-extra/esm";var g=class r{_appDataPath;_configFileName="config.json";get _configPath(){return b(this._appDataPath,this._configFileName)}constructor(t){let e=process.env.APPDATA;if(!e)switch(F()){case"win32":e=this._getWindowsAppDataPath();break;case"linux":e=this._getLinuxAppDataPath();break;case"darwin":e=this._getMacAppDataPath();break;default:e=this._getFallbackAppDataPath();break}this._appDataPath=b(e,t)}_getWindowsAppDataPath(){return b(_(),"AppData","Roaming")}_getLinuxAppDataPath(){return b(_(),".config")}_getMacAppDataPath(){return b(_(),"Library","Application Support")}_getFallbackAppDataPath(){return F()==="win32"?this._getWindowsAppDataPath():this._getLinuxAppDataPath()}static _getDirectories(t){return J(t,{withFileTypes:!0}).filter(e=>e.isDirectory()).map(e=>b(t,e.name))}static getProjectDirectories(t,e,n){let i=t.filter(u=>v(u)&&k(u).isDirectory()),a=e.filter(u=>v(u)&&k(u).isDirectory()),c=n.filter(u=>v(u)&&k(u).isDirectory());return[].concat(...i.map(r._getDirectories)).filter(u=>c.includes(u)?!1:!i.includes(u)).concat(...a)}safeValidateConfig(t){return!t.basePath||typeof t.basePath!="string"||!v(t.basePath)?{success:!1,error:"Invalid project base path in config! Must be a valid directory."}:!t.openWith||typeof t.openWith!="string"?{success:!1,error:"Invalid command in config! Must be a string."}:t.subDirectories&&!Array.isArray(t.subDirectories)?{success:!1,error:"Invalid subdirectories in config! Must be an array of directories."}:t.projectDirectories?.include&&!Array.isArray(t.projectDirectories.include)?{success:!1,error:"Invalid project include in config! Must be an array of directories."}:t.projectDirectories?.exclude&&!Array.isArray(t.projectDirectories.exclude)?{success:!1,error:"Invalid project exclude in config! Must be an array of directories."}:{success:!0,data:{basePath:t.basePath,subDirectories:t.subDirectories??[],openWith:t.openWith,projectDirectories:{include:t.projectDirectories?.include??[],exclude:t.projectDirectories?.exclude??[]}}}}async safeGetConfig(){try{if(!await M(this._configPath))return{success:!1,error:"No config file found. Please initialize project manager first."}}catch{return{success:!1,error:"An unexpected error occurred. Please try again."}}try{let t=await H(this._configPath),e=this.safeValidateConfig(t);return e.success?{success:!0,data:e.data}:e}catch{return{success:!1,error:"An unexpected error occurred. Please try again."}}}async safeConfigExists(){try{return{success:!0,data:await M(this._configPath)}}catch{return{success:!1,error:"An unexpected error occurred. Please try again."}}}async safeCreateConfig(t){let e=this.safeValidateConfig(t);if(!e.success)return e;try{return await L(this._configPath,e.data,{spaces:2,encoding:"utf-8"}),{success:!0,data:void 0}}catch{return{success:!1,error:"An unexpected error occurred. Please try again."}}}async safeSetConfig(t,e){try{return await L(this._configPath,{basePath:t.basePath??e.basePath,subDirectories:t.subDirectories??e.subDirectories,openWith:t.openWith??e.openWith,projectDirectories:{include:t.projectDirectories?.include??e.projectDirectories.include,exclude:t.projectDirectories?.exclude??e.projectDirectories.exclude}},{spaces:2,encoding:"utf-8"}),{success:!0,data:void 0}}catch{return{success:!1,error:"An unexpected error occurred. Please try again."}}}};import{cancel as B,intro as Q,isCancel as X,outro as Z,log as R}from"@clack/prompts";import{TextPrompt as ee}from"@clack/core";import o from"picocolors";import te from"is-unicode-supported";import{join as z}from"node:path";import{homedir as V}from"node:os";import{existsSync as K,lstatSync as G}from"node:fs";import{Fzf as re,extendedMatch as ie}from"fzf";function p(r){return r?typeof r!="string"?[]:[...new Set(r.split(","))].map(e=>e.trim()).filter(Boolean):[]}function f(r,t=!1){return function(e){let n=p(e);if(!n.every(i=>K(t?i:z(r,i))))return"Some directories do not exist";if(!n.every(i=>G(t?i:z(r,i)).isDirectory()))return"Some paths are not directories"}}function E(r){if(!K(r))return"Path does not exist";if(!r.toLowerCase().startsWith(V().toLowerCase())||!r[V().length+1])return"Directory must be inside your home directory";if(!G(r).isDirectory())return"Path is not a directory"}var d=class r{static getErrorString(t,e=!1){let n=typeof t=="string"?t:t instanceof Error?t.message:"An unexpected error occurred. Please try again.";return`${e?`${o.bgRed(o.black(" ERROR "))} `:""}${o.red(n)}`}static getSuccessString(t,e=!1){return`${e?`${o.bgGreen(o.black(" SUCCESS "))} `:""}${o.green(t)}`}static getInfoString(t,e=!1){return`${e?`${o.bgCyan(o.black(" INFO "))} `:""}${o.cyan(t)}`}static error=t=>{R.error(r.getErrorString(t,!0))};static success=t=>{R.success(r.getSuccessString(t,!0))};static info=t=>{R.info(r.getInfoString(t,!0))}};function y(r){Q(d.getInfoString(r??"Project Manager".toUpperCase()))}function O(r){return`${o.bgCyan(" OPTIONAL ")} ${r}`}function P(r){Z(d.getSuccessString(r??"Thanks for using Project Manager!"))}function $(r,t="Process cancelled."){X(r)&&(B(t),process.exit(0))}function l(r,t=!1){B(d.getErrorString(r,!0)),process.exit(t?1:0)}var oe=te(),h=(r,t)=>oe?r:t,ne=h("\u25C6","*"),se=h("\u25A0","x"),ae=h("\u25B2","x"),ce=h("\u25C7","o"),ue=h("\u251C","+"),m=h("\u2502","|"),N=h("\u2514","\u2014"),le=r=>{switch(r){case"initial":case"active":return o.cyan(ne);case"cancel":return o.red(se);case"error":return o.yellow(ae);case"submit":return o.green(ce)}};function x(r){let t=[],[e,...n]=r.split(`
`);return t.push(`${e}`,...n.map(i=>`${o.cyan(m)}  ${i}`)),t.join(`
`)}var pe=(r,t,e)=>e(r.item).trim().length-e(t.item).trim().length;function de(r,t){return r.split("").map((i,a)=>t.has(a)?o.green(i):i).join("")}function w({title:r,color:t,end:e}){return`${r}${t}  ${e}`}function U(r){let t=new re(r.items,{match:ie,tiebreakers:[pe]});return new ee({validate(e){if(!t.find(e).length)return"No results found."},placeholder:r.placeholder,defaultValue:r.defaultValue,initialValue:r.initialValue,render(){let e=t.find(this.value??""),n=`${o.gray(m)}
${le(this.state)}  ${r.message}
`,i=r.placeholder?o.inverse(r.placeholder[0])+o.dim(r.placeholder.slice(1)):o.inverse(o.hidden("_")),a=this.value?this.valueWithCursor:i;switch(this.state){case"error":return w({title:n.trim(),color:`
${o.yellow(m)}`,end:`${a}
${o.yellow(N)}  ${o.yellow(this.error)}
`});case"submit":return this.value=e[0].item,w({title:n,color:o.gray(m),end:o.dim(e[0].item||r.placeholder)});case"cancel":return w({title:n,color:o.gray(m),end:`${o.strikethrough(o.dim(this.value??""))}${this.value?.trim()?`
`+o.gray(m):""}`});default:return w({title:n,color:o.cyan(m),end:`${a}${e.length?`
`+e.map(c=>`${o.cyan(ue)}  ${o.dim(de(c.item.normalize(),c.positions))}`).join(`
`):""}
${o.cyan(N)}
`})}}}).prompt()}import{homedir as ge}from"node:os";import{join as me}from"node:path";import{cancel as W,group as he,text as C}from"@clack/prompts";import{homedir as fe}from"os";var s={basePath:()=>x(`Where do you store your projects? (must be inside '${fe()}')`),subDirectories:r=>x(`Which subdirectories do you store your projects in?
Separate them with a comma
(must be inside '${r}', only specify relative paths)`),openWith:()=>x(`Which program do you want to open your projects with?
(the current working directory will be the selected project directory)`),projectInclude:()=>x(`Which projects do you want to include?
Separate them with a comma (must be a full path)`),projectExclude:r=>x(`Which projects/directories do you want to exclude?
Separate them with a comma
(must be inside of a subdirectory you specified,
only specify relative path to '${r}')`),subDirectoriesExample:"For example: nodejs/cli-tools, nodejs/web-apps",projectIncludeExample:"For example: nodejs/portfolio",projectExcludeExample:"For example: nodejs/portfolio/backend",openWithExample:"For example: code ."},j={init:"Initialization cancelled.",config:"Configuration cancelled."},A={done:()=>"Overriden config. You can continue using Project Manager.",cancelled:()=>"Configuration cancelled."};async function q(r){y();let t=await r.safeConfigExists();if(!t.success)return l(t.error);if(t.data)return l("Initialization already done. You can start using Project Manager.");let e=await he({basePath:()=>C({message:s.basePath(),initialValue:me(ge()),validate:E}),subDirectories:({results:{basePath:i}})=>i?C({message:s.subDirectories(i),placeholder:s.subDirectoriesExample,validate:f(i)}):W(j.init),openWith:()=>C({message:s.openWith(),placeholder:s.openWithExample,validate:i=>{if(!i)return"Command cannot be empty"}}),projectInclude:({results:{basePath:i}})=>i?C({message:O(s.projectInclude()),placeholder:s.projectIncludeExample,validate:f(i,!0)}):W(j.init),projectExclude:({results:{basePath:i}})=>i?C({message:O(s.projectExclude(i)),placeholder:s.projectExcludeExample,validate:f(i)}):W(j.init)},{onCancel:()=>{W(j.init),process.exit(0)}}),n=await r.safeCreateConfig({basePath:e.basePath,subDirectories:p(e.subDirectories),projectDirectories:{include:p(e.projectInclude),exclude:p(e.projectExclude)},openWith:e.openWith});if(!n.success)return l(n.error);P("Initialization done. You can start using Project Manager.")}import{join as I,sep as be}from"node:path";import{execa as ye}from"execa";async function T(r){y();let t=await r.safeGetConfig();if(!t.success)return l(t.error);let{data:e}=t,n=g.getProjectDirectories(e.subDirectories.map(a=>I(e.basePath,a)),e.projectDirectories.include.map(a=>I(e.basePath,a)),e.projectDirectories.exclude.map(a=>I(e.basePath,a))).map(a=>a.replace(e.basePath+be,"")),i=await U({items:n,message:`Enter a project directory (relative to '${e.basePath}')`});$(i,"Project selection cancelled."),e.openWith&&await ye(e.openWith,{cwd:I(e.basePath,i),stdio:"inherit"}),P()}import{cancel as Pe,group as xe,multiselect as De,text as S}from"@clack/prompts";function D(r,t=!1){return t?r.length?r.join(", "):"":r.length?`'${r.join("', '")}'`:"none"}async function Y(r){y();let t=await r.safeGetConfig();if(!t.success)return l(t.error);let{data:e}=t,n=await De({message:"Select option(s) to edit",options:[{label:"Base path",value:"basePath",hint:`current: '${e.basePath}'`},{label:"Subdirectories",value:"subDirectories",hint:`current: ${D(e.subDirectories)}`},{label:"Command to open projects with",value:"openWith",hint:`current: '${e.openWith}'`},{label:"Included projects",value:"include",hint:`current: ${D(e.projectDirectories.include)}`},{label:"Excluded projects",value:"exclude",hint:`current: ${D(e.projectDirectories.exclude)}`}],required:!0});$(n,A.cancelled());let i=await xe({...n.includes("basePath")&&{basePath:()=>S({message:s.basePath(),initialValue:e.basePath,validate:E})},...n.includes("subDirectories")&&{subDirectories:({results:{basePath:c}})=>S({message:s.subDirectories(c??e.basePath),initialValue:e.subDirectories.length?D(e.subDirectories,!0):void 0,placeholder:e.subDirectories.length?void 0:s.subDirectoriesExample,validate:f(c??e.basePath)})},...n.includes("openWith")&&{openWith:()=>S({message:s.openWith(),initialValue:e.openWith??void 0,placeholder:e.openWith?void 0:s.openWithExample})},...n.includes("include")&&{includeProjects:({results:{basePath:c}})=>S({message:s.projectInclude(),initialValue:e.projectDirectories.include.length?D(e.projectDirectories.include,!0):void 0,placeholder:e.projectDirectories.include.length?void 0:s.projectIncludeExample,validate:f(c??e.basePath,!0)})},...n.includes("exclude")&&{excludeProjects:({results:{basePath:c}})=>S({message:s.projectExclude(c??e.basePath),initialValue:e.projectDirectories.exclude.length?D(e.projectDirectories.exclude,!0):void 0,placeholder:e.projectDirectories.exclude.length?void 0:s.projectExcludeExample,validate:f(c??e.basePath)})}},{onCancel:()=>{Pe(A.cancelled()),process.exit(0)}}),a=await r.safeSetConfig({basePath:i.basePath,subDirectories:n.includes("subDirectories")?p(i.subDirectories):void 0,projectDirectories:{include:n.includes("include")?p(i.includeProjects):void 0,exclude:n.includes("exclude")?p(i.excludeProjects):void 0},openWith:i.openWith},e);if(!a.success)return l(a.error);P(A.done())}async function Ce(){let r=new g("project-manager"),t=new je().name("project-manager").description("Project Manager is a CLI tool for managing projects and easily navigate between them.").version(d.getInfoString(`v${process.env.npm_package_version}`,!0)).option("--","select a project");t.command("select").description("select a project").action(async()=>{await T(r)}),t.command("init").description("initialize project manager").action(async()=>{await q(r)}),t.command("config").description("configure project manager").action(async()=>{await Y(r)});try{process.argv.length===2?await T(r):await t.parseAsync(process.argv),process.exit(0)}catch(e){l(e),process.exit(1)}}Ce().catch(r=>{d.error(r),process.exit(1)});
